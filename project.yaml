version: '3.0'

expectations:

  population_size: 20000

actions:

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # 
  ## DO NOT EDIT project.yaml DIRECTLY 
  ## This file is created by create_project_actions.R 
  ## Edit and run create_project_actions.R to update the project.yaml 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # 
  ##  
  ## Part 1. Generate Study Population 
  ##  
  ## Generate dummy data for all eligible population 

  generate_study_population_all:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_all
      --output-format feather
    outputs:
      highly_sensitive:
        cohort: output/input_all.feather

  ## Generate dummy data for study population - vaccinated 

  generate_study_population_vaccinated:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_vaccinated
      --output-format feather
    outputs:
      highly_sensitive:
        cohort: output/input_vaccinated.feather

  ## Generate dummy data for study population - infected 

  generate_study_population_infected:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_infected
      --output-format feather
    outputs:
      highly_sensitive:
        cohort: output/input_infected.feather

  ## Part 2. Create Analysis Data Sets 
  ## Data Cleaning 
  ## Stage 0 Data Cleaning - all 

  stage0_data_cleaning_all:
    run: r:latest analysis/stage0_data_cleaning.R all
    needs:
    - generate_study_population_all
    outputs:
      highly_sensitive:
        cohort: output/input_stage0_all.rds
      moderately_sensitive:
        variable_check_table_CSV: output/not_for_review/descriptives/table_0_all.csv
        variable_check_table_HTML: output/not_for_review/descriptives/table_0_all.html
        histogram_numerical_variable: output/not_for_review/descriptives/histogram_*_all.svg
        table_gp: output/not_for_review/descriptives/table_gp_*_all*

  ## Stage 0 Data Cleaning - vaccinated 

  stage0_data_cleaning_vaccinated:
    run: r:latest analysis/stage0_data_cleaning.R vaccinated
    needs:
    - generate_study_population_vaccinated
    outputs:
      highly_sensitive:
        cohort: output/input_stage0_vaccinated.rds
      moderately_sensitive:
        variable_check_table_CSV: output/not_for_review/descriptives/table_0_vaccinated.csv
        variable_check_table_HTML: output/not_for_review/descriptives/table_0_vaccinated.html
        histogram_numerical_variable: output/not_for_review/descriptives/histogram_*_vaccinated.svg
        table_gp: output/not_for_review/descriptives/table_gp_*_vaccinated*

  ## Stage 0 Data Cleaning - infected 

  stage0_data_cleaning_infected:
    run: r:latest analysis/stage0_data_cleaning.R infected
    needs:
    - generate_study_population_infected
    outputs:
      highly_sensitive:
        cohort: output/input_stage0_infected.rds
      moderately_sensitive:
        variable_check_table_CSV: output/not_for_review/descriptives/table_0_infected.csv
        variable_check_table_HTML: output/not_for_review/descriptives/table_0_infected.html
        histogram_numerical_variable: output/not_for_review/descriptives/histogram_*_infected.svg
        table_gp: output/not_for_review/descriptives/table_gp_*_infected*

  ## Define eligible population 
  ## Stage 1 define eligible population - all 

  stage1_define_eligible_population_all:
    run: r:latest analysis/stage1_define_eligible_population.R all
    needs:
    - stage0_data_cleaning_all
    outputs:
      highly_sensitive:
        cohort: output/input_stage1_all.rds
      moderately_sensitive:
        flow_chart_csv: output/flow_chart_all.csv
        flow_chart_html: output/flow_chart_all.html

  ## Stage 1 define eligible population - vaccinated 

  stage1_define_eligible_population_vaccinated:
    run: r:latest analysis/stage1_define_eligible_population.R vaccinated
    needs:
    - stage0_data_cleaning_vaccinated
    outputs:
      highly_sensitive:
        cohort: output/input_stage1_vaccinated.rds
      moderately_sensitive:
        flow_chart_csv: output/flow_chart_vaccinated.csv
        flow_chart_html: output/flow_chart_vaccinated.html

  ## Stage 1 define eligible population - infected 

  stage1_define_eligible_population_infected:
    run: r:latest analysis/stage1_define_eligible_population.R infected
    needs:
    - stage0_data_cleaning_infected
    outputs:
      highly_sensitive:
        cohort: output/input_stage1_infected.rds
      moderately_sensitive:
        flow_chart_csv: output/flow_chart_infected.csv
        flow_chart_html: output/flow_chart_infected.html

  ## Part 3. Figures and tables 
  ## Table 1. Patient Characteristics - all 

  table_1_all:
    run: r:latest analysis/table_1.R all
    needs:
    - stage1_define_eligible_population_all
    outputs:
      moderately_sensitive:
        descriptive_table_CSV: output/review/descriptives/table_1_all.csv
        descriptive_table_HTML: output/review/descriptives/table_1_all.html

  ## Table 1. Patient Characteristics - vaccinated 

  table_1_vaccinated:
    run: r:latest analysis/table_1.R vaccinated
    needs:
    - stage1_define_eligible_population_vaccinated
    outputs:
      moderately_sensitive:
        descriptive_table_CSV: output/review/descriptives/table_1_vaccinated.csv
        descriptive_table_HTML: output/review/descriptives/table_1_vaccinated.html

  ## Table 1. Patient Characteristics - infected 

  table_1_infected:
    run: r:latest analysis/table_1.R infected
    needs:
    - stage1_define_eligible_population_infected
    outputs:
      moderately_sensitive:
        descriptive_table_CSV: output/review/descriptives/table_1_infected.csv
        descriptive_table_HTML: output/review/descriptives/table_1_infected.html

  ## Table_1_combined - all table 1 combined 

  table_1_combined:
    run: r:latest analysis/table_1_combined.R
    needs:
    - table_1_all
    - table_1_vaccinated
    - table_1_infected
    outputs:
      moderately_sensitive:
        table: output/review/descriptives/table_1_combined*

  ## Define eligible population 
  ## Table 2. Event count and incidence rate - all 

  table_2_all:
    run: r:latest analysis/table_2.R all
    needs:
    - stage1_define_eligible_population_all
    outputs:
      moderately_sensitive:
        incidence_rate_table_CSV: output/review/descriptives/table_2_all.csv
        incidence_rate_talbe_HTML: output/review/descriptives/table_2_all.html

  ## Table 2. Event count and incidence rate - all_vax_c 

  table_2_all_vax_c:
    run: r:latest analysis/table_2.R all_vax_c
    needs:
    - stage1_define_eligible_population_all
    outputs:
      moderately_sensitive:
        incidence_rate_table_CSV: output/review/descriptives/table_2_all_vax_c.csv
        incidence_rate_talbe_HTML: output/review/descriptives/table_2_all_vax_c.html

  ## Table 2. Event count and incidence rate - vaccinated 

  table_2_vaccinated:
    run: r:latest analysis/table_2.R vaccinated
    needs:
    - stage1_define_eligible_population_vaccinated
    outputs:
      moderately_sensitive:
        incidence_rate_table_CSV: output/review/descriptives/table_2_vaccinated.csv
        incidence_rate_talbe_HTML: output/review/descriptives/table_2_vaccinated.html

  ## Table 2. Event count and incidence rate - infected 

  table_2_infected:
    run: r:latest analysis/table_2.R infected
    needs:
    - stage1_define_eligible_population_infected
    outputs:
      moderately_sensitive:
        incidence_rate_table_CSV: output/review/descriptives/table_2_infected.csv
        incidence_rate_talbe_HTML: output/review/descriptives/table_2_infected.html

  ## Table_2_combined - all table 2 combined 

  table_2_combined:
    run: r:latest analysis/table_2_combined.R
    needs:
    - table_2_all
    - table_2_all_vax_c
    - table_2_vaccinated
    - table_2_infected
    outputs:
      moderately_sensitive:
        table: output/review/descriptives/table_2_combined*

  ## table_3 - sequence count 

  table_3_all:
    run: r:latest analysis/table_3.R
    needs:
    - stage1_define_eligible_population_all
    outputs:
      moderately_sensitive:
        sequence_count_table_CSV: output/review/descriptives/table_3.csv
        sequence_count_table_HTML: output/review/descriptives/table_3.html

  ## Figure_1 - long covid count 

  figure_1_all:
    run: r:latest analysis/figure_1.R
    needs:
    - stage1_define_eligible_population_all
    outputs:
      moderately_sensitive:
        figure_long_covid_count_all: output/figure_1_*.svg
        table_csv_long_covid_count_all: output/review/descriptives/long_covid_count_*_all.csv
        table_html_long_covid_count_all: output/review/descriptives/long_covid_count_*_all.html

  ## Figure_hist - Histogram of days from covid to long covid 

  figure_hist_all:
    run: r:latest analysis/figure_hist.R
    needs:
    - stage1_define_eligible_population_all
    outputs:
      moderately_sensitive:
        figure_days_c_to_lc: output/review/descriptives/figure_hist.svg
        table_csv_summary: output/review/descriptives/summary_days_c_to_long.csv
        table_bin_count: output/review/descriptives/hist_*

  ## Figure - cumulative probability plot 

  figure_cum_prob_km_all:
    run: r:latest analysis/figure_cum_prob_km.R
    needs:
    - stage1_define_eligible_population_all
    outputs:
      moderately_sensitive:
        cum_prob_plot: output/review/descriptives/figure_cum_*.svg

  ## Suppl_table_1 - frequencies of snomed code for long covid diagnosis 

  suppl_table_1_all:
    run: r:latest analysis/suppl_table_1.R
    needs:
    - stage1_define_eligible_population_all
    outputs:
      moderately_sensitive:
        pie_chart_long_covid_code: output/review/descriptives/suppl_figure_pie.svg
        table_csv_long_covid_code: output/review/descriptives/suppl_table_1.csv
        table_html_long_covid_code: output/review/descriptives/suppl_table_1.html

  ## Suppl_figure_1 - long covid count by region 

  suppl_figure_1_all:
    run: r:latest analysis/suppl_figure_1.R
    needs:
    - stage1_define_eligible_population_all
    outputs:
      moderately_sensitive:
        figure_long_covid_count_region: output/review/descriptives/suppl_figure_1_*.svg
        table_csv_long_covid_count_region: output/review/descriptives/long_covid_count_*.csv
        table_html_long_covid_region: output/review/descriptives/long_covid_count_*.html

  ## Summarise survival data 

  summarise_survival_data_all:
    run: r:latest analysis/stage2_summarise_survival_data.R
    needs:
    - stage1_define_eligible_population_all
    outputs:
      moderately_sensitive:
        summary_survival_data_CSV: output/review/descriptives/summarise_survival_data.csv
        summary_survival_data_HTML: output/review/descriptives/summarise_survival_data.html

  ## Part 4. Modelling 
  ## Development Cox model 
  ## post-viral fatigue 

  development_cox_model_fatigue:
    run: r:latest analysis/stage3_fatigue_survival_analysis.R
    needs:
    - stage1_define_eligible_population_all
    outputs:
      moderately_sensitive:
        summary_survival_data: output/review/model/analysis_data_summary_fatigue*
        cox_model_output: output/review/model/hazard_ratio_estimates_fatigue*

  ## Development Cox Model - all 

  development_cox_model_all:
    run: r:latest analysis/stage3_model_development.R all
    needs:
    - stage1_define_eligible_population_all
    outputs:
      moderately_sensitive:
        supporting_document: output/review/model/analysis_data_summary_all*
        hazard_ratios: output/review/model/hazard_ratio_estimates_*_all*
        selected_variables: output/not_for_review/model/selected_variables_all.csv
        model_selection: output/not_for_review/model/model_selection_all.csv
        AIC: output/review/model/AIC_all.csv

  ## Development Cox Model - all_vax_c 

  development_cox_model_all_vax_c:
    run: r:latest analysis/stage3_model_development.R all_vax_c
    needs:
    - stage1_define_eligible_population_all
    outputs:
      moderately_sensitive:
        supporting_document: output/review/model/analysis_data_summary_all_vax_c*
        hazard_ratios: output/review/model/hazard_ratio_estimates_*_all_vax_c*
        selected_variables: output/not_for_review/model/selected_variables_all_vax_c.csv
        model_selection: output/not_for_review/model/model_selection_all_vax_c.csv
        AIC: output/review/model/AIC_all_vax_c.csv

  ## Development Cox Model - vaccinated 

  development_cox_model_vaccinated:
    run: r:latest analysis/stage3_model_development.R vaccinated
    needs:
    - stage1_define_eligible_population_vaccinated
    outputs:
      moderately_sensitive:
        supporting_document: output/review/model/analysis_data_summary_vaccinated*
        hazard_ratios: output/review/model/hazard_ratio_estimates_*_vaccinated*
        selected_variables: output/not_for_review/model/selected_variables_vaccinated.csv
        model_selection: output/not_for_review/model/model_selection_vaccinated.csv
        AIC: output/review/model/AIC_vaccinated.csv

  ## Development Cox Model - all_vax_td 

  development_cox_model_all_vax_td:
    run: r:latest analysis/stage3_model_development.R all_vax_td
    needs:
    - stage1_define_eligible_population_all
    outputs:
      moderately_sensitive:
        supporting_document: output/review/model/analysis_data_summary_all_vax_td*
        hazard_ratios: output/review/model/hazard_ratio_estimates_*_all_vax_td*
        selected_variables: output/not_for_review/model/selected_variables_all_vax_td.csv
        model_selection: output/not_for_review/model/model_selection_all_vax_td.csv
        AIC: output/review/model/AIC_all_vax_td.csv

  ## Development Cox Model - infected 

  development_cox_model_infected:
    run: r:latest analysis/stage3_model_development.R infected
    needs:
    - stage1_define_eligible_population_infected
    outputs:
      moderately_sensitive:
        supporting_document: output/review/model/analysis_data_summary_infected*
        hazard_ratios: output/review/model/hazard_ratio_estimates_*_infected*
        selected_variables: output/not_for_review/model/selected_variables_infected.csv
        model_selection: output/not_for_review/model/model_selection_infected.csv
        AIC: output/review/model/AIC_infected.csv

  ## Development Cox Model - all 

  development_model_age_sex_all:
    run: r:latest analysis/stage3_4_model_dev_eval_age_sex.R all
    needs:
    - stage1_define_eligible_population_all
    outputs:
      moderately_sensitive:
        fit_cox_model: output/not_for_review/model/fit_cox_model_age_sex_all.rds
        hazard_ratios: output/review/model/hazard_ratio_estimates_age_sex_*_all*
        performance_measure: output/review/model/performance_measures_age_sex_*_all*
        survival_plot: output/review/model/survival_plot_*_age_sex_*_all.svg

  ## Development Cox Model - all_vax_c 

  development_model_age_sex_all_vax_c:
    run: r:latest analysis/stage3_4_model_dev_eval_age_sex.R all_vax_c
    needs:
    - stage1_define_eligible_population_all
    outputs:
      moderately_sensitive:
        fit_cox_model: output/not_for_review/model/fit_cox_model_age_sex_all_vax_c.rds
        hazard_ratios: output/review/model/hazard_ratio_estimates_age_sex_*_all_vax_c*
        performance_measure: output/review/model/performance_measures_age_sex_*_all_vax_c*
        survival_plot: output/review/model/survival_plot_*_age_sex_*_all_vax_c.svg

  ## Development Cox Model - vaccinated 

  development_model_age_sex_vaccinated:
    run: r:latest analysis/stage3_4_model_dev_eval_age_sex.R vaccinated
    needs:
    - stage1_define_eligible_population_vaccinated
    outputs:
      moderately_sensitive:
        fit_cox_model: output/not_for_review/model/fit_cox_model_age_sex_vaccinated.rds
        hazard_ratios: output/review/model/hazard_ratio_estimates_age_sex_*_vaccinated*
        performance_measure: output/review/model/performance_measures_age_sex_*_vaccinated*
        survival_plot: output/review/model/survival_plot_*_age_sex_*_vaccinated.svg

  ## Development Cox Model - all_vax_td 

  development_model_age_sex_all_vax_td:
    run: r:latest analysis/stage3_4_model_dev_eval_age_sex.R all_vax_td
    needs:
    - stage1_define_eligible_population_all
    outputs:
      moderately_sensitive:
        fit_cox_model: output/not_for_review/model/fit_cox_model_age_sex_all_vax_td.rds
        hazard_ratios: output/review/model/hazard_ratio_estimates_age_sex_*_all_vax_td*
        performance_measure: output/review/model/performance_measures_age_sex_*_all_vax_td*
        survival_plot: output/review/model/survival_plot_*_age_sex_*_all_vax_td.svg

  ## Development Cox Model - infected 

  development_model_age_sex_infected:
    run: r:latest analysis/stage3_4_model_dev_eval_age_sex.R infected
    needs:
    - stage1_define_eligible_population_infected
    outputs:
      moderately_sensitive:
        fit_cox_model: output/not_for_review/model/fit_cox_model_age_sex_infected.rds
        hazard_ratios: output/review/model/hazard_ratio_estimates_age_sex_*_infected*
        performance_measure: output/review/model/performance_measures_age_sex_*_infected*
        survival_plot: output/review/model/survival_plot_*_age_sex_*_infected.svg

  ## Development Cox Model - all 

  development_model_age_sex_adjusted_all:
    run: r:latest analysis/stage3_4_model_dev_eval_age_sex_adjusted.R all
    needs:
    - stage1_define_eligible_population_all
    outputs:
      moderately_sensitive:
        hazard_ratios: output/review/model/HR_estimates_age_sex_adjusted_all*
        performance_measure: output/review/model/performance_measures_age_sex_adjusted_all*

  ## Development Cox Model - all_vax_c 

  development_model_age_sex_adjusted_all_vax_c:
    run: r:latest analysis/stage3_4_model_dev_eval_age_sex_adjusted.R all_vax_c
    needs:
    - stage1_define_eligible_population_all
    outputs:
      moderately_sensitive:
        hazard_ratios: output/review/model/HR_estimates_age_sex_adjusted_all_vax_c*
        performance_measure: output/review/model/performance_measures_age_sex_adjusted_all_vax_c*

  ## Development Cox Model - vaccinated 

  development_model_age_sex_adjusted_vaccinated:
    run: r:latest analysis/stage3_4_model_dev_eval_age_sex_adjusted.R vaccinated
    needs:
    - stage1_define_eligible_population_vaccinated
    outputs:
      moderately_sensitive:
        hazard_ratios: output/review/model/HR_estimates_age_sex_adjusted_vaccinated*
        performance_measure: output/review/model/performance_measures_age_sex_adjusted_vaccinated*

  ## Development Cox Model - all_vax_td 

  development_model_age_sex_adjusted_all_vax_td:
    run: r:latest analysis/stage3_4_model_dev_eval_age_sex_adjusted.R all_vax_td
    needs:
    - stage1_define_eligible_population_all
    outputs:
      moderately_sensitive:
        hazard_ratios: output/review/model/HR_estimates_age_sex_adjusted_all_vax_td*
        performance_measure: output/review/model/performance_measures_age_sex_adjusted_all_vax_td*

  ## Development Cox Model - infected 

  development_model_age_sex_adjusted_infected:
    run: r:latest analysis/stage3_4_model_dev_eval_age_sex_adjusted.R infected
    needs:
    - stage1_define_eligible_population_infected
    outputs:
      moderately_sensitive:
        hazard_ratios: output/review/model/HR_estimates_age_sex_adjusted_infected*
        performance_measure: output/review/model/performance_measures_age_sex_adjusted_infected*

  ## Subset variables 

  identify_subset_variables:
    run: r:latest analysis/stage3_identify_subset_variables.R
    needs:
    - development_cox_model_all
    - development_cox_model_all_vax_c
    - development_cox_model_all_vax_td
    - development_cox_model_vaccinated
    - development_cox_model_infected
    outputs:
      moderately_sensitive:
        subset_variables: output/review/model/selected_vars.csv

  ## Development Cox Model using a subset of variables - all 

  model_subset_variables_all:
    run: r:latest analysis/stage3_model_subset_variables.R all
    needs:
    - identify_subset_variables
    - stage1_define_eligible_population_all
    outputs:
      moderately_sensitive:
        hazard_ratios: output/review/model/hazard_ratio_estimates_subset*_all*
        performance_measure: output/review/model/performance_measures_subset*_all*

  ## Development Cox Model using a subset of variables - all_vax_c 

  model_subset_variables_all_vax_c:
    run: r:latest analysis/stage3_model_subset_variables.R all_vax_c
    needs:
    - identify_subset_variables
    - stage1_define_eligible_population_all
    outputs:
      moderately_sensitive:
        hazard_ratios: output/review/model/hazard_ratio_estimates_subset*_all_vax_c*
        performance_measure: output/review/model/performance_measures_subset*_all_vax_c*

  ## Development Cox Model using a subset of variables - vaccinated 

  model_subset_variables_vaccinated:
    run: r:latest analysis/stage3_model_subset_variables.R vaccinated
    needs:
    - identify_subset_variables
    - stage1_define_eligible_population_vaccinated
    outputs:
      moderately_sensitive:
        hazard_ratios: output/review/model/hazard_ratio_estimates_subset*_vaccinated*
        performance_measure: output/review/model/performance_measures_subset*_vaccinated*

  ## Development Cox Model using a subset of variables - all_vax_td 

  model_subset_variables_all_vax_td:
    run: r:latest analysis/stage3_model_subset_variables.R all_vax_td
    needs:
    - identify_subset_variables
    - stage1_define_eligible_population_all
    outputs:
      moderately_sensitive:
        hazard_ratios: output/review/model/hazard_ratio_estimates_subset*_all_vax_td*
        performance_measure: output/review/model/performance_measures_subset*_all_vax_td*

  ## Development Cox Model using a subset of variables - infected 

  model_subset_variables_infected:
    run: r:latest analysis/stage3_model_subset_variables.R infected
    needs:
    - identify_subset_variables
    - stage1_define_eligible_population_infected
    outputs:
      moderately_sensitive:
        hazard_ratios: output/review/model/hazard_ratio_estimates_subset*_infected*
        performance_measure: output/review/model/performance_measures_subset*_infected*

  ## Evaluation Cox model 

  evaluation_cox_model_all:
    run: r:latest analysis/stage4_model_evaluation.R all
    needs:
    - stage1_define_eligible_population_all
    outputs:
      moderately_sensitive:
        performance_measure_CSV: output/review/model/performance_measures_*_all.csv
        performance_measure_HTML: output/review/model/performance_measures_*_all.html
        survival_plot: output/review/model/survival_plot_*_all.svg

  evaluation_cox_model_all_vax_c:
    run: r:latest analysis/stage4_model_evaluation.R all_vax_c
    needs:
    - stage1_define_eligible_population_all
    outputs:
      moderately_sensitive:
        performance_measure_CSV: output/review/model/performance_measures_*_all_vax_c.csv
        performance_measure_HTML: output/review/model/performance_measures_*_all_vax_c.html
        survival_plot: output/review/model/survival_plot_*_all_vax_c.svg

  evaluation_cox_model_vaccinated:
    run: r:latest analysis/stage4_model_evaluation.R vaccinated
    needs:
    - stage1_define_eligible_population_vaccinated
    outputs:
      moderately_sensitive:
        performance_measure_CSV: output/review/model/performance_measures_*_vaccinated.csv
        performance_measure_HTML: output/review/model/performance_measures_*_vaccinated.html
        survival_plot: output/review/model/survival_plot_*_vaccinated.svg

  evaluation_cox_model_all_vax_td:
    run: r:latest analysis/stage4_model_evaluation.R all_vax_td
    needs:
    - stage1_define_eligible_population_all
    outputs:
      moderately_sensitive:
        performance_measure_CSV: output/review/model/performance_measures_*_all_vax_td.csv
        performance_measure_HTML: output/review/model/performance_measures_*_all_vax_td.html
        survival_plot: output/review/model/survival_plot_*_all_vax_td.svg

  evaluation_cox_model_infected:
    run: r:latest analysis/stage4_model_evaluation.R infected
    needs:
    - stage1_define_eligible_population_infected
    outputs:
      moderately_sensitive:
        performance_measure_CSV: output/review/model/performance_measures_*_infected.csv
        performance_measure_HTML: output/review/model/performance_measures_*_infected.html
        survival_plot: output/review/model/survival_plot_*_infected.svg

