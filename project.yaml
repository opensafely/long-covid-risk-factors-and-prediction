version: '3.0'

expectations:

  population_size: 10000

actions:

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # 
  ## DO NOT EDIT project.yaml DIRECTLY 
  ## This file is created by create_project_actions.R 
  ## Edit and run create_project_actions.R to update the project.yaml 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # 

  generate_study_population:
    run: cohortextractor:latest generate_cohort --study-definition study_definition
      --output-format feather
    outputs:
      highly_sensitive:
        cohort: output/input.feather

  stage0_data_cleaning:
    run: r:latest analysis/stage0_data_cleaning.R
    needs:
    - generate_study_population
    outputs:
      highly_sensitive:
        cohort: output/input_stage0.rds
      moderately_sensitive:
        variable_check_table_CSV: output/table_0.csv
        variable_check_table_HTML: output/table_0.html

  stage1_define_eligible_population:
    run: r:latest analysis/stage1_define_eligible_population.R
    needs:
    - stage0_data_cleaning
    outputs:
      highly_sensitive:
        cohort: output/input_stage1_*.rds
      moderately_sensitive:
        flow_chart_csv: output/flow_chart.csv
        flow_chart_html: output/flow_chart.html

  table_1:
    run: r:latest analysis/table_1.R
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        descriptive_table_CSV: output/table_1.csv
        descriptive_table_HTML: output/table_1.html

  table_2:
    run: r:latest analysis/table_2.R
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        incidence_rate_table_CSV: output/table_2.csv
        incidence_rate_talbe_HTML: output/table_2.html

  table_3:
    run: r:latest analysis/table_3.R
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        sequence_count_table_CSV: output/table_3.csv
        sequence_count_table_HTML: output/table_3.html

  figure_1:
    run: r:latest analysis/figure_1.R
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        figure_long_covid_count_all: output/figure_1_*.svg
        table_csv_long_covid_count_all: output/long_covid_count_*_all.csv
        table_html_long_covid_count_all: output/long_covid_count_*_all.html

  figure_2:
    run: r:latest analysis/figure_2.R
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        figure_days_c_to_lc: output/figure_hist.svg
        table_csv_summary: output/summary_days_c_to_long.csv

  suppl_table_1:
    run: r:latest analysis/suppl_table_1.R
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        pie_chart_long_covid_code: output/suppl_figure_pie.svg
        table_csv_long_covid_code: output/suppl_table_1.csv
        table_html_long_covid_code: output/suppl_table_1.html

  suppl_figure_1:
    run: r:latest analysis/suppl_figure_1.R
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        figure_long_covid_count_region: output/suppl_figure_1_*.svg
        table_csv_long_covid_count_region: output/long_covid_count_*.csv
        table_html_long_covid_region: output/long_covid_count_*.html

  summarise_survival_data:
    run: r:latest analysis/stage2_summarise_survival_data.R
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        summary_survival_data_CSV: output/summarise_survival_data.csv
        summary_survival_data_HTML: output/summarise_survival_data.html

  ## Development Cox Model - all 

  development_cox_model_all:
    run: r:latest analysis/stage3_model_development.R all
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        ph_test_CSV: output/PH_test_*_all.csv
        hazard_ratios_CSV: output/hazard_ratio_estimates_*_all.csv
        hazard_ratios_HTML: output/hazard_ratio_estimates_*_all.html

  ## Development Cox Model - vax_c 

  development_cox_model_vax_c:
    run: r:latest analysis/stage3_model_development.R vax_c
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        ph_test_CSV: output/PH_test_*_vax_c.csv
        hazard_ratios_CSV: output/hazard_ratio_estimates_*_vax_c.csv
        hazard_ratios_HTML: output/hazard_ratio_estimates_*_vax_c.html

  ## Development Cox Model - all_vax_td 

  development_cox_model_all_vax_td:
    run: r:latest analysis/stage3_model_development.R all_vax_td
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        ph_test_CSV: output/PH_test_*_all_vax_td.csv
        hazard_ratios_CSV: output/hazard_ratio_estimates_*_all_vax_td.csv
        hazard_ratios_HTML: output/hazard_ratio_estimates_*_all_vax_td.html

  ## Evaluation Cox Model - all 

  evaluation_cox_model_all:
    run: r:latest analysis/stage4_model_evaluation.R all
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        performance_measure_CSV: output/performance_measures_*_all.csv
        performance_measure_HTML: output/performance_measures_*_all.html
        survival_plot: output/survival_plot_*_all.svg

  ## Evaluation Cox Model - vax_c 

  evaluation_cox_model_vax_c:
    run: r:latest analysis/stage4_model_evaluation.R vax_c
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        performance_measure_CSV: output/performance_measures_*_vax_c.csv
        performance_measure_HTML: output/performance_measures_*_vax_c.html
        survival_plot: output/survival_plot_*_vax_c.svg

  ## Validation Cox Model - all 

  validation_cox_model_all:
    run: r:latest analysis/stage5_model_validation.R all
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        val_performance_measure_CSV: output/val_performance_measures_all.csv
        val_cal_plot: output/val_cal_plot_*_all.svg
        val_re_cal_plot: output/val_re_cal_plot_*_all.svg

  ## Validation Cox Model - vax_c 

  validation_cox_model_vax_c:
    run: r:latest analysis/stage5_model_validation.R vax_c
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        val_performance_measure_CSV: output/val_performance_measures_vax_c.csv
        val_cal_plot: output/val_cal_plot_*_vax_c.svg
        val_re_cal_plot: output/val_re_cal_plot_*_vax_c.svg

