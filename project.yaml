version: '3.0'

expectations:

  population_size: 10000

actions:

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # 
  ## DO NOT EDIT project.yaml DIRECTLY 
  ## This file is created by create_project_actions.R 
  ## Edit and run create_project_actions.R to update the project.yaml 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # 
  ## Generate dummy data for study_definition for all eligible population 

  generate_study_population_all:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_all
      --output-format feather
    outputs:
      highly_sensitive:
        cohort: output/input_all.feather

  ## Generate dummy data for study_definition - vaccinated 

  generate_study_population_vaccinated:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_vaccinated
      --output-format feather
    outputs:
      highly_sensitive:
        cohort: output/input_vaccinated.feather

  ## Stage 0 - Data cleaning 

  stage0_data_cleaning:
    run: r:latest analysis/stage0_data_cleaning.R both
    needs:
    - generate_study_population_all
    - generate_study_population_vaccinated
    outputs:
      highly_sensitive:
        cohort: output/input_stage0_*.rds
      moderately_sensitive:
        variable_check_table_CSV: output/not_for_review/descriptives/table_0_*.csv
        variable_check_table_HTML: output/not_for_review/descriptives/table_0_*.html
        histogram_numerical_variable: output/not_for_review/descriptives/histogram_*

  ## Stage 1 - Define eligible population 

  stage1_define_eligible_population:
    run: r:latest analysis/stage1_define_eligible_population.R both
    needs:
    - stage0_data_cleaning
    outputs:
      highly_sensitive:
        cohort: output/input_stage1_*.rds
      moderately_sensitive:
        flow_chart_csv: output/flow_chart_*.csv
        flow_chart_html: output/flow_chart_*.html

  ## table_1 - Patient characteristics 

  table_1:
    run: r:latest analysis/table_1.R both
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        descriptive_table_CSV: output/review/descriptives/table_1_*.csv
        descriptive_table_HTML: output/review/descriptives/table_1_*.html

  ## table_2 - event count and incidence rate 

  table_2:
    run: r:latest analysis/table_2.R both
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        incidence_rate_table_CSV: output/review/descriptives/table_2_*.csv
        incidence_rate_talbe_HTML: output/review/descriptives/table_2_*.html

  ## table_3 - sequence count 

  table_3:
    run: r:latest analysis/table_3.R
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        sequence_count_table_CSV: output/review/descriptives/table_3.csv
        sequence_count_table_HTML: output/review/descriptives/table_3.html

  ## Figure_1 - long covid count 

  figure_1:
    run: r:latest analysis/figure_1.R
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        figure_long_covid_count_all: output/figure_1_*.svg
        table_csv_long_covid_count_all: output/review/descriptives/long_covid_count_*_all.csv
        table_html_long_covid_count_all: output/review/descriptives/long_covid_count_*_all.html

  ## Figure_2 - days from covid to long covid 

  figure_2:
    run: r:latest analysis/figure_2.R
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        figure_days_c_to_lc: output/review/descriptives/figure_hist.svg
        table_csv_summary: output/review/descriptives/summary_days_c_to_long.csv

  ## Suppl_table_1 - frequencies of snomed code for long covid diagnosis 

  suppl_table_1:
    run: r:latest analysis/suppl_table_1.R
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        pie_chart_long_covid_code: output/review/descriptives/suppl_figure_pie.svg
        table_csv_long_covid_code: output/review/descriptives/suppl_table_1.csv
        table_html_long_covid_code: output/review/descriptives/suppl_table_1.html

  ## Suppl_figure_1 - long covid count by region 

  suppl_figure_1:
    run: r:latest analysis/suppl_figure_1.R
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        figure_long_covid_count_region: output/review/descriptives/suppl_figure_1_*.svg
        table_csv_long_covid_count_region: output/review/descriptives/long_covid_count_*.csv
        table_html_long_covid_region: output/review/descriptives/long_covid_count_*.html

  ## Summarise survival data 

  summarise_survival_data:
    run: r:latest analysis/stage2_summarise_survival_data.R
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        summary_survival_data_CSV: output/review/descriptives/summarise_survival_data.csv
        summary_survival_data_HTML: output/review/descriptives/summarise_survival_data.html

  ## Development Cox model 
  ## Development Cox Model - all 

  development_cox_model_all:
    run: r:latest analysis/stage3_model_development.R all
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        hazard_ratios_CSV: output/review/model/hazard_ratio_estimates_*_all.csv
        hazard_ratios_HTML: output/review/model/hazard_ratio_estimates_*_all.html

  ## Development Cox Model - vax_c 

  development_cox_model_vax_c:
    run: r:latest analysis/stage3_model_development.R vax_c
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        hazard_ratios_CSV: output/review/model/hazard_ratio_estimates_*_vax_c.csv
        hazard_ratios_HTML: output/review/model/hazard_ratio_estimates_*_vax_c.html

  ## Development Cox Model - vaccinated 

  development_cox_model_vaccinated:
    run: r:latest analysis/stage3_model_development.R vaccinated
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        hazard_ratios_CSV: output/review/model/hazard_ratio_estimates_*_vaccinated.csv
        hazard_ratios_HTML: output/review/model/hazard_ratio_estimates_*_vaccinated.html

  ## Development Cox Model - all_vax_td 

  development_cox_model_all_vax_td:
    run: r:latest analysis/stage3_model_development.R all_vax_td
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        hazard_ratios_CSV: output/review/model/hazard_ratio_estimates_*_all_vax_td.csv
        hazard_ratios_HTML: output/review/model/hazard_ratio_estimates_*_all_vax_td.html

  ## Evaluation Cox model 
  ## Evaluation Cox Model - all 

  evaluation_cox_model_all:
    run: r:latest analysis/stage4_model_evaluation.R all
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        performance_measure_CSV: output/review/model/performance_measures_*_all.csv
        performance_measure_HTML: output/review/model/performance_measures_*_all.html
        survival_plot: output/review/model/survival_plot_*_all.svg

  ## Evaluation Cox Model - vax_c 

  evaluation_cox_model_vax_c:
    run: r:latest analysis/stage4_model_evaluation.R vax_c
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        performance_measure_CSV: output/review/model/performance_measures_*_vax_c.csv
        performance_measure_HTML: output/review/model/performance_measures_*_vax_c.html
        survival_plot: output/review/model/survival_plot_*_vax_c.svg

  ## Evaluation Cox Model - vaccinated 

  evaluation_cox_model_vaccinated:
    run: r:latest analysis/stage4_model_evaluation.R vaccinated
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        performance_measure_CSV: output/review/model/performance_measures_*_vaccinated.csv
        performance_measure_HTML: output/review/model/performance_measures_*_vaccinated.html
        survival_plot: output/review/model/survival_plot_*_vaccinated.svg

  ## Evaluation Cox Model - all_vax_td 

  evaluation_cox_model_all_vax_td:
    run: r:latest analysis/stage4_model_evaluation.R all_vax_td
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        performance_measure_CSV: output/review/model/performance_measures_*_all_vax_td.csv
        performance_measure_HTML: output/review/model/performance_measures_*_all_vax_td.html
        survival_plot: output/review/model/survival_plot_*_all_vax_td.svg

  ## Validation Cox Model - all 

  validation_cox_model_all:
    run: r:latest analysis/stage5_model_validation_iecv.R all
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        val_performance_measure_CSV: output/review/model/val_performance_measures_all.csv
        val_cal_plot: output/review/model/val_cal_plot_*_all.svg
        val_re_cal_plot: output/review/model/val_re_cal_plot_*_all.svg

  ## Validation Cox Model - vax_c 

  validation_cox_model_vax_c:
    run: r:latest analysis/stage5_model_validation_iecv.R vax_c
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        val_performance_measure_CSV: output/review/model/val_performance_measures_vax_c.csv
        val_cal_plot: output/review/model/val_cal_plot_*_vax_c.svg
        val_re_cal_plot: output/review/model/val_re_cal_plot_*_vax_c.svg

  ## Validation Cox Model - vaccinated 

  validation_cox_model_vaccinated:
    run: r:latest analysis/stage5_model_validation_iecv.R vaccinated
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        val_performance_measure_CSV: output/review/model/val_performance_measures_vaccinated.csv
        val_cal_plot: output/review/model/val_cal_plot_*_vaccinated.svg
        val_re_cal_plot: output/review/model/val_re_cal_plot_*_vaccinated.svg

  ## Validation Cox Model - all_vax_td 

  validation_cox_model_all_vax_td:
    run: r:latest analysis/stage5_model_validation_iecv.R all_vax_td
    needs:
    - stage1_define_eligible_population
    outputs:
      moderately_sensitive:
        val_performance_measure_CSV: output/review/model/val_performance_measures_all_vax_td.csv
        val_cal_plot: output/review/model/val_cal_plot_*_all_vax_td.svg
        val_re_cal_plot: output/review/model/val_re_cal_plot_*_all_vax_td.svg

